name: Secret Scan (Gitleaks)

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          set -euo pipefail
          GITLEAKS_VERSION="8.18.4"
          curl -sSL -o gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz gitleaks
          sudo mv gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Run gitleaks (working tree, report)
        run: |
          set -euo pipefail
          mkdir -p gitleaks_out
          set +e
          gitleaks detect \
            --no-git \
            --source . \
            --config .gitleaks.toml \
            --redact \
            --report-format json \
            --report-path gitleaks_out/gitleaks_report.json
          CODE=$?
          set -e
          echo "gitleaks_exit_code=$CODE" | tee gitleaks_out/exit_code.txt
          if [ "$CODE" -ne 0 ]; then
            echo "Gitleaks found leaks. See artifact: gitleaks_out/gitleaks_report.json"
            exit 1
          fi

      - name: Upload gitleaks report (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks_out
          if-no-files-found: ignore
          retention-days: 7
